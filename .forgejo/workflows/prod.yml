name: Forgejo Actions v-workspace
run-name: ${{ runner.actor }} is testing out Forgejo Actions ğŸš€
on:
  push:
    branches:
      - "main"

jobs:
  build:
    runs-on: docker
    container:
      image: thevlang/vlang:alpine-dev
    outputs:
      build-tag: ${{ steps.meta.outputs.tags }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Debug workspace
        run: |
          echo "ğŸ“ Current workspace:"
          pwd
          ls -la
          echo "ğŸ”§ V version:"
          v version

      - name: Build application
        run: |
          v -prod -o v-admin .

      - name: Test build output
        run: |
          echo "âœ… Build output:"
          ls -la
          [ -f "v-admin" ] && echo "Build successful" || echo "Build failed"

      - name: Prepare artifacts
        run: |
          echo "ğŸ“¦ Preparing artifacts..."
          # åˆ›å»ºå¿…è¦çš„é…ç½®æ–‡ä»¶æˆ–ç›®å½•
          mkdir -p etc
          [ -f "etc/config.toml" ] || echo "# Configuration file" > etc/config.toml

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: v-admin-build
          path: |
            v-admin
            etc/
            Dockerfile
          retention-days: 1

  deploy:
    runs-on: docker
    needs: build
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: v-admin-build

      - name: Set up Docker
        run: |
          echo "ğŸ³ Docker version:"
          docker --version

      - name: Verify artifacts
        run: |
          echo "ğŸ“ Deployment workspace:"
          pwd
          ls -la
          echo "âœ… Artifacts verification:"
          [ -f "v-admin" ] && echo "âœ“ Binary found" || echo "âœ— Binary missing"
          [ -f "Dockerfile" ] && echo "âœ“ Dockerfile found" || echo "âœ— Dockerfile missing"

      - name: Clean up existing containers
        run: |
          echo "ğŸ§¹ Cleaning up existing containers..."
          docker rm -f v-admin || true
          docker rmi -f avey777/v-admin || true

      - name: Build Docker image
        run: |
          echo "ğŸ”¨ Building Docker image..."
          docker buildx build \
            --no-cache \
            --rm=true \
            --progress=plain \
            -f Dockerfile \
            -t avey777/v-admin .

      - name: Verify Docker image
        run: |
          echo "ğŸ” Verifying Docker image..."
          docker images | grep v-admin

      - name: Run Container
        run: |
          echo "ğŸš€ Starting container..."
          # åˆ›å»ºæœ¬åœ°é…ç½®ç›®å½•
          mkdir -p ~/.config/
          # å¦‚æœé…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
          [ -f "~/.config/v-admin/config.toml" ] || touch ~/.config/v-admin/config.toml

          docker run --name=v-admin \
            --restart=unless-stopped \
            -p 9009:9009 \
            -e CONFIG_PATH=backend/etc/config.toml \
            -v ~/.config/v-admin/config.toml:/workspace/v-admin/etc/config.toml \
            -d avey777/v-admin

      - name: Check container status
        run: |
          echo "ğŸ“Š Container status:"
          docker ps -a | grep v-admin
          echo "ğŸ” Container logs:"
          docker logs v-admin --tail 50 || true

      - name: Health check
        run: |
          echo "ğŸ¥ Performing health check..."
          sleep 10
          docker ps | grep v-admin && echo "âœ… Container is running" || echo "âŒ Container failed to start"

      - name: Clean Docker cache
        run: |
          echo "ğŸ§¹ Cleaning Docker cache..."
          docker builder prune -f
          docker image prune -f

  notification:
    runs-on: docker
    needs: [build, deploy]
    if: always()
    steps:
      - name: Deployment status
        run: |
          echo "ğŸ‰ Deployment completed!"
          echo "Build job status: ${{ needs.build.result }}"
          echo "Deploy job status: ${{ needs.deploy.result }}"

          if [ "${{ needs.build.result }}" = "success" ] && [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… All jobs completed successfully!"
          else
            echo "âŒ Some jobs failed. Check the logs above."
            exit 1
          fi
